<html lang="es">
    <head>
            <meta name="viewport" content="initial-scale=1.0, width=device-width" />
            <meta charset="UTF-8" />
        
    </head>
    <body>
        <div id="map" ></div>
        <script src="https://js.api.here.com/v3/3.1/mapsjs-core.js" type="text/javascript" charset="utf-8"></script>
        <script src="https://js.api.here.com/v3/3.1/mapsjs-service.js" type="text/javascript" charset="utf-8"></script>
        <script src="https://js.api.here.com/v3/3.1/mapsjs-mapevents.js"type="text/javascript" charset="utf-8"></script>
        <script>
           
            const platform = new H.service.Platform({ 
                "apikey": "GC5cgevB0asxbMKe-8ZEYPpAzYbfZO-G-fshPsPB4Wo",
                "app_id" : "BoQIQN3uxK92Db8ybn4I",
                "app_code" : "PmkNkJZM_D7Zg9IL_pmzPw"
});// se conecta al servicio de here mediante la apikey unica


           // Obtain the default map types from the platform object:
var defaultLayers = platform.createDefaultLayers();


const start = async() =>{
    var map = new H.Map(
  document.getElementById('map'),//se genera el mapa utilizando la libreria de here
  defaultLayers.vector.normal.map,
  {
    zoom: 11, //se añade zoom
    center: { lat: 4.61496, lng: -74.06941 },//se añade donde queremos que inicie el mapa
    volatility: true
  });
  
   
   var behavior = new H.mapevents.Behavior(new H.mapevents.MapEvents(map)); //añade zoom y que se pueda mover el mapa
   
    /*var marker = new H.map.Marker({lat : 52.5, lng: 13.4 });//genera un punto en el mapa segun las coordenadas
    map.addObject(marker);//se añade al mapa*/

    var geocoder = platform.getGeocodingService();//se inicia el servicio de geocoding
 
    var geo =  query =>{
        geocoder.geocode(
            {
                "searchtext": query
            },
            success=>{
            var locations = (success.Response.View[0].Result[0].Location.DisplayPosition);
                console.log(locations);
    function addDraggableMarker(map, behavior){
            var marker1 = new H.map.Marker(
                {
                    lat : locations.Latitude, //obtenemos latitud  
                    lng : locations.Longitude, //obtenemos longitud
                    volatility : true
                    
                }
            );
            marker1.draggable = true;
            map.addObject(marker1);
            
  // disable the default draggability of the underlying map
  // and calculate the offset between mouse and target's position
  // when starting to drag a marker object:
  map.addEventListener('dragstart', function(ev) {
    var target = ev.target,
        pointer = ev.currentPointer;
    if (target instanceof H.map.Marker) {
      var targetPosition = map.geoToScreen(target.getGeometry());
      target['offset'] = new H.math.Point(pointer.viewportX - targetPosition.x, pointer.viewportY - targetPosition.y);
      behavior.disable();
    }
  }, false);


  // re-enable the default draggability of the underlying map
  // when dragging has completed
  map.addEventListener('dragend', function(ev) {
    var target = ev.target;
    if (target instanceof H.map.Marker) {
      behavior.enable();
    }
  }, false);

  // Listen to the drag event and move the position of the marker
  // as necessary
   map.addEventListener('drag', function(ev) {
    var target = ev.target,
        pointer = ev.currentPointer;
    if (target instanceof H.map.Marker) {
      target.setGeometry(map.screenToGeo(pointer.viewportX - target['offset'].x, pointer.viewportY - target['offset'].y));
    }
  }, false);
    }


// Add the click event listener.
addDraggableMarker(map, behavior); //añadimos la funcion para que el marcador se pueda mover por el mapa con su propio comportamiento
            },
            error =>{
                console.error(error);
            }
        );
        }
        geo("Bogota D.C, COL"); // se genera un query global para busquedas

     

    

        const reverseGeocode = coords =>{ //se crea una variable de geocodigo en reversa 
            return new Promise((resolve, reject) =>{
                geocoder.reverseGeocode(
                    {
                        prox : coords.Latitude + "," + coords.Longitude, // se le pasan latitud y longitud para su conversion
                        mode : "retrieveAddresses",
                        maxresults: 1 // se asigna solo 1 resultado para evitar choques con mas direcciones
                    },
                    success=>{
                        resolve(success);
                    },
                    reject=>{
                        reject(error);
                    }
                );
            });
        }
const location = await reverseGeocode({ Latitude: 4.61496, Longitude: -74.06941});
console.log(location);

}
start();
      
        </script>
    </body>
</html>
